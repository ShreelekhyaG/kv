image: maven:3.5.4-jdk-10
before_script:
- apt-get update -qq && apt-get install
variables:
  SONAR_URL: "http://jenkins-immersive.stackroute.in:9000/"
  SONAR_LOGIN: "admin"
  SONAR_PASSWORD: "Admin12#"

stages:
- test
- build
- codecoverage
- test_quality

sonarqube_master_job:
  stage: test_quality
  only:
  - master
  image: maven:3.3.9-jdk-8-alpine
  script:
  - mvn --batch-mode verify sonar:sonar -Dsonar.host.url=$SONAR_URL -Dsonar.login=$SONAR_LOGIN -Dsonar.password=$SONAR_PASSWORD
test:
  script: mvn test
build:
  script: mvn package
codecoverage:
  script:
  - "mvn clean test"
  - "mvn jacoco:report"
  - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/",instructions, "instructions covered"; print 100*covered/instructions, "% covered" }' config-server/target/site/jacoco/jacoco.csv
  coverage: '/Code coverage: \d+\.\d+/'
  artifacts:
      paths:
      - target/site/jacoco/

#codecoverage:
#  script:
#    - mvn clean test
#    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' target/site/jacoco/jacoco.csv
#  coverage: '\d+.\d+ \% 'covered
